# School Site Test VM

A virtual machine that provisions and configures HCPSS school sites.

## Vagrant or Docker?

You can use either Vagrant or Docker to serve the websites.

If you choose Vagrant, all sites will be created and run from a VM. The Docker
option is meant to be a little and more light and faster. It only provisions and
serves the sites you tell it to.

## Requirements

For the Vagrant option, [Vagrant](https://www.vagrantup.com/) and
[Ansible](https://www.ansible.com/).

For the Docker version, you just need [Docker](https://www.docker.com/).

### Ansible

If you are using Docker, you can skip this section.

Ansible roles are listed in ansible/requirements.yml and can be installed using
`ansible-galaxy`.  Roles can be installed at the host-level or bundled into your
local working copy of the repository. If you choose the latter option, add an
empty ansible/roles folder and an ansible.cfg file at ansible/ansible.cfg.

Your ansible.cfg file should look like:

```
[defaults]

roles_path = <your path>/schoolsite-test-vm/ansible/roles
```

Install the roles with:

```
$ ansible-galaxy install -r ansible/requirements.yml
```

You may need a *sudo* on the front or a *--force* on the end.

## Setup

### Hosts file

You need to update your /etc/hosts file to point to direct schools.dev requests
to either the address of the Vagrant box (192.168.33.2) or to 127.0.0.1 if you
are using Docker.

```
# For Vagrant
192.168.33.2 schools.dev
192.168.33.2 aes.schools.dev
192.168.33.2 ahs.schools.dev
192.168.33.2 arl.schools.dev
192.168.33.2 bbes.schools.dev
192.168.33.2 bbms.schools.dev
etc...

# For Docker
127.0.0.1 schools.dev
127.0.0.1 aes.schools.dev
127.0.0.1 ahs.schools.dev
127.0.0.1 arl.schools.dev
127.0.0.1 bbes.schools.dev
127.0.0.1 bbms.schools.dev
etc...
```

This list can be generated by executing the [hosts_example.py](#hosts_examplepy)
utility on the guest machine so you can easily copy and paste it to your hosts
file.

### Databases

All the database exports should be placed in the database/ directory with this
naming convention:

```
<school-code>.bak.sql.gz
```

### Drupal installation folders

The source files of the Drupal sites should be placed in the data/ directory and
should be named after the school code:

```
data/
  aes/
  ahs/
  etc...
```

### Run it

Then you should be able to:

```
$ vagrant up
```

To launch all schools with Vagrant. Or:

```
$ ./utilities/launch.sh bses
```

To launch schools one at a time with Docker.

## Usage

If you are going active development on a theme of module, you can place it in
extensions/modules or extensions/themes. After provisioning the vagrant box,
you can place the module or theme in it's installation location with a symbolic
link like this:

```
$ ln -s \
    /vagrant/extensions/modules/my_module \
    /var/www/schools/bses/sites/all/modules/my_module
```

## Utilities

The utilities folder contains scripts that help perform various tedious tasks.

### process_backup.py

This is a python script that organizes a backup folder which is organized like
this:

```
/backup_location/
  es/
    site_es_aes-2016-01-15.bak.sql.gz
    site_es_aes-2016-01-15.tar.gz
  hs/
    site_hs_ahs-2016-01-15.bak.sql.gz
    site_hs_ahs-2016-01-15.tar.gz
```

And makes it like this:

```
/destination/
  data/
    aes/
      <drupal-files>
    ahs/
      <drupal-files>
  database/
    aes.bak.sql.gz
    ahs.bak.sql.gz
```

Which is what ansible will expect. Here's an example:

```
$ ./utilities/process_backup.py -b ~/Downloads/2016-01-15/ -d ~/Sites/schoolsite-test-vm/
```

### reset_school.py

This only works with Vagrant.

This is a script that is meant to be run from the guest. It resets a school to
it's original state when it was imported:

```
$ /vagrant/utilities/reset_school.py bses
```

### hosts_example.py

This only works with Vagrant.

Generates example entries for your /etc/hosts file. This should be run on the
guest and it uses the actual vhost entries to generate the list.

```
$ /vagrant/utilities/hosts_example.py
```

### batch_command.py

This only works with Vagrant.

Iterates over the school installations and performs the command on all of them.
For instance, this would clear caches on all schools:

```
$ /vagrant/utilities/batch_command.py "drush cc all"
```

You can also use tokens *target* and *school_code* to substitute the target
directory. For instance, this will add a module you are developing to all
schools as a symbolic link:

```
$ /vagrant/utilities/batch_command.py "ln -sfn /vagrant/extensions/modules/mymodule {target}/sites/all/modules/mymodule"
```

And this will revert all schools to their original state:

```
$ /vagrant/utilities/batch_command.py "/vagrant/utilities/reset_school.py {school_code}"
```

### elasticsearch.sh and elasticsearch_hs.sh

Only works for Vagrant currently.

Perform deployments for version 1.9 of the school deployment module for ES/MS
and HS sites respectively.

For ES/MS sites, you first need to update schoolsite_deploy and for HS sites,
you need to update schoolsite_deploy and hcpss_schoolsite_theme. Then

```
/vagrant/utilities/elasticsearch.sh fres_test
/vagrant/utilities/elasticsearch_hs.sh omhs
```
